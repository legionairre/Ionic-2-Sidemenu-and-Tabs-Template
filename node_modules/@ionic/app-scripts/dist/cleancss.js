"use strict";
var path_1 = require('path');
var config_1 = require('./util/config');
var logger_1 = require('./util/logger');
var helpers_1 = require('./util/helpers');
var cleanCss = require('clean-css');
function cleancss(context, cleanCssConfig) {
    context = config_1.generateContext(context);
    cleanCssConfig = config_1.fillConfigDefaults(context, cleanCssConfig, CLEANCSS_TASK_INFO);
    var logger = new logger_1.Logger('cleancss');
    var sourceFile = path_1.join(context.buildDir, cleanCssConfig.sourceFileName);
    var destFileName = path_1.join(context.buildDir, cleanCssConfig.destFileName);
    return helpers_1.readFileAsync(sourceFile).then(function (fileContent) {
        logger_1.Logger.debug("cleancss read: " + sourceFile);
        return runCleanCss(fileContent);
    }).then(function (output) {
        logger_1.Logger.debug("cleancss write: " + destFileName);
        return helpers_1.writeFileAsync(destFileName, output.styles);
    }).then(function () {
        return logger.finish();
    }).catch(function (err) {
        logger.fail(err);
        return Promise.reject(err);
    });
}
exports.cleancss = cleancss;
function runCleanCss(fileContent) {
    return new Promise(function (resolve, reject) {
        var minifier = new cleanCss();
        minifier.minify(fileContent, function (err, minified) {
            if (err) {
                reject(err);
            }
            else if (minified.errors && minified.errors.length > 0) {
                // just return the first error for now I guess
                reject(new Error(minified.errors[0]));
            }
            else {
                resolve(minified);
            }
        });
    });
}
var CLEANCSS_TASK_INFO = {
    fullArgConfig: '--cleancss',
    shortArgConfig: '-e',
    envConfig: 'ionic_cleancss',
    defaultConfigFilename: 'cleancss.config'
};
